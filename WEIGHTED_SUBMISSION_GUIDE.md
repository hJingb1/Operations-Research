# 综合排名赛道提交指南

> **已完成**: 在阶段2添加了"综合排名"赛道的提交入口
> **修改文件**: `fronted/src/components/SubmissionModal.jsx`

---

## ✅ 已实现的功能

### 1. 提交界面新增第三个选项

在阶段2的"提交方案"弹窗中，现在有三个赛道可选：

```
💰 总成本最低 (当前: ¥XXX)
⏱️ 总工期最短 (当前: XX 天)
🏆 综合排名 (工期: XX 天 | 成本: ¥XXX)  ← 新增！
```

### 2. 动态显示评分说明

当选择"综合排名"时，会显示黄色提示框：

```
📊 评分说明：
• 基准工期：120天 | 基准成本：¥200,000
• 综合分数 = 工期超出% × 40% + 成本超出% × 60%
• 分数越低越好（0%表示达到或优于基准值）
```

### 3. 提交逻辑优化

- **cost赛道**: score = totalCost
- **time赛道**: score = totalDuration
- **weighted赛道**: score = 0（后端根据baseline自动计算综合分数）

---

## 🎯 使用流程

### 学生视角

1. **进入阶段2**
   - 完成阶段1后重新登录自动进入

2. **优化项目方案**
   - 拖动任务调整时间
   - 压缩关键路径任务
   - 平衡工期和成本

3. **查看当前指标**
   - Dashboard顶部显示：
     - 总工期（天）
     - 总直接费用
     - 总间接费用
     - 项目总费用

4. **提交方案**
   - 点击 **"提交方案"** 按钮
   - 选择 **🏆 综合排名**
   - 查看当前工期和成本
   - 点击 **"确认提交"**

5. **查看排名**
   - 切换到 **"排行榜"** 标签
   - 点击 **🏆 综合排名** 按钮
   - 查看自己的排名和分数

---

## 📊 综合排名评分逻辑

### 公式
```
工期超出% = MAX(0, (实际工期 - 120) / 120 × 100)
成本超出% = MAX(0, (实际成本 - 200000) / 200000 × 100)
综合分数 = 0.4 × 工期超出% + 0.6 × 成本超出%
```

### 示例

**提交数据**:
- 工期: 110天
- 成本: ¥210,000

**计算过程**:
```
工期超出% = MAX(0, (110-120)/120×100) = 0% (低于基准，按0计算)
成本超出% = MAX(0, (210000-200000)/200000×100) = 5%
综合分数 = 0.4 × 0% + 0.6 × 5% = 3%
```

**排名**: 分数越低，排名越靠前

---

## 🔧 教师配置

如需调整基准值和权重，修改 `backend/server.js` 第**107-110行**：

```javascript
const BASELINE_DURATION = 120;    // 基准工期（天）
const BASELINE_COST = 200000;     // 基准成本（元）
const DURATION_WEIGHT = 0.4;      // 工期权重（40%）
const COST_WEIGHT = 0.6;          // 成本权重（60%）
```

**修改后记得**:
1. 重启后端服务
2. 同步更新前端提示信息：
   - `SubmissionModal.jsx` 第85行
   - `Leaderboard.jsx` 第162行

详见 [WEIGHTED_CONFIG_GUIDE.md](./WEIGHTED_CONFIG_GUIDE.md)

---

## 🧪 测试步骤

### 1. 准备测试账号

```sql
-- 确保账号通过了阶段1
SELECT u.name, p.is_passed
FROM Users u
JOIN Phase1Results p ON u.id = p.user_id
WHERE u.student_id = '测试学号';
```

### 2. 登录阶段2

使用通过阶段1的账号登录

### 3. 调整项目参数

- 压缩某些任务（改变工期）
- 观察成本变化

### 4. 提交到weighted赛道

点击"提交方案" → 选择"🏆 综合排名" → 确认提交

### 5. 验证数据库

```sql
-- 查看提交记录
SELECT
    u.name,
    s.track,
    s.project_duration,
    s.total_cost,
    s.submitted_at
FROM Submissions s
JOIN Users u ON s.user_id = u.id
WHERE s.track = 'weighted'
ORDER BY s.submitted_at DESC;
```

### 6. 检查排行榜

刷新前端 → 排行榜 → 点击"🏆 综合排名" → 应该能看到提交记录

---

## 🎨 界面截图说明

### 提交弹窗（选中weighted）

```
┌─────────────────────────────────────────┐
│  提交你的优化方案                        │
│  请选择一个赛道进行提交...               │
│                                          │
│  ○ 💰 总成本最低 (当前: ¥195,000)       │
│  ○ ⏱️ 总工期最短 (当前: 115 天)         │
│  ● 🏆 综合排名 (工期: 115天|成本: ¥195k) │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │ 📊 评分说明：                       │ │
│  │ • 基准工期：120天 | 基准成本：¥200k │ │
│  │ • 综合分数 = 工期超出%×40% + ...   │ │
│  │ • 分数越低越好（0%表示达到基准）    │ │
│  └────────────────────────────────────┘ │
│                                          │
│                    [关闭] [确认提交]     │
└─────────────────────────────────────────┘
```

### 排行榜（weighted赛道）

```
┌────────────────────────────────────────────────────┐
│ 排行榜                                              │
│ [💰 成本最小] [⏱️ 工期最短] [🏆 综合排名] ← 选中   │
│                                                     │
│ 排名  姓名   综合分数  工期   成本      提交时间     │
│ 🥇   张三    2.50%   118天  ¥198,000  2025-12-17   │
│ 🥈   李四    4.00%   125天  ¥195,000  2025-12-17   │
│ 🥉   王五    8.50%   130天  ¥210,000  2025-12-16   │
│                                                     │
│ ┌────────────────────────────────────────────────┐ │
│ │ 📊 评分说明：                                   │ │
│ │ • 基准工期：120天 | 基准成本：¥200,000         │ │
│ │ • 综合分数 = 工期超出% × 40% + 成本超出% × 60% │ │
│ │ • 分数越低越好（0%表示达到或优于基准值）        │ │
│ └────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────┘
```

---

## 🚀 快速验证

### 前端验证

1. 刷新浏览器（Ctrl+F5）
2. 进入阶段2
3. 点击"提交方案"
4. 应该看到3个选项，包括"🏆 综合排名"

### 后端验证

查看后端日志，提交weighted赛道后应该输出：

```
Received submission: { track: 'weighted', score: 0, projectDuration: 115, totalCost: 195000 }
```

---

## 📝 代码修改总结

### 文件: `SubmissionModal.jsx`

**修改点1: 提交逻辑（第14-53行）**
```javascript
// 根据赛道确定分数
let score;
if (selectedTrack === 'cost') {
  score = totalCost;
} else if (selectedTrack === 'time') {
  score = totalDuration;
} else if (selectedTrack === 'weighted') {
  score = 0;  // 后端会根据baseline计算
}
```

**修改点2: UI选项（第69-72行）**
```javascript
<label>
  <input type="radio" value="weighted"
         checked={selectedTrack === 'weighted'}
         onChange={() => setSelectedTrack('weighted')} />
  🏆 综合排名 (工期: {totalDuration} 天 | 成本: ¥{Math.round(totalCost).toLocaleString()})
</label>
```

**修改点3: 动态提示（第74-90行）**
```javascript
{selectedTrack === 'weighted' && (
  <div style={{ /* 黄色提示框样式 */ }}>
    <strong>📊 评分说明：</strong>
    <ul>
      <li>基准工期：120天 | 基准成本：¥200,000</li>
      <li>综合分数 = 工期超出% × 40% + 成本超出% × 60%</li>
      <li>分数越低越好（0%表示达到或优于基准值）</li>
    </ul>
  </div>
)}
```

---

## ⚠️ 注意事项

### 1. 基准值一致性

确保以下三处的基准值相同：
- `server.js` 第107-110行（计算逻辑）
- `SubmissionModal.jsx` 第85行（提交提示）
- `Leaderboard.jsx` 第162行（排行榜说明）

### 2. weighted赛道的score字段

- 提交时 `score = 0`
- 后端不使用这个字段排序
- 排行榜查询时使用 `weighted_score`（计算得出）

### 3. 提交频率

- 每个赛道独立记录
- 只保留历史最佳（cost/time赛道）
- weighted赛道按最新提交覆盖

---

## 🔗 相关文档

- [综合排行榜设计方案](./WEIGHTED_LEADERBOARD_DESIGN.md)
- [基准值配置指南](./WEIGHTED_CONFIG_GUIDE.md)
- [数据库SQL教程](./POSTGRESQL_TUTORIAL.md)
- [阶段过渡调试指南](./DEBUG_PHASE_TRANSITION.md)

---

**功能已完成 ✅**
刷新前端即可使用！无需重启后端。
